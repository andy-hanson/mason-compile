if (typeof define !== 'function') var define = require('amdefine')(module);define(['exports', 'module', 'esast/dist/ast', 'esast/dist/util', '../context', '../manglePath', '../MsAst', '../util', './ast-constants', './ms-call', './transpile', './util'], function (exports, module, _esastDistAst, _esastDistUtil, _context, _manglePath, _MsAst, _util, _astConstants, _msCall, _transpile, _util2) {
	'use strict';

	module.exports = transpileModule;

	function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

	var _manglePath2 = _interopRequireDefault(_manglePath);

	function transpileModule() {
		const body = (0, _util2.tLines)(this.lines);

		_transpile.verifyResults.builtinPathToNames.forEach((imported, path) => {
			if (path !== 'global') {
				const importedDeclares = [];
				let opImportDefault = null;
				let defaultName = (0, _util.last)(path.split('/'));
				for (const name of imported) {
					const declare = _MsAst.LocalDeclare.plain(this.loc, name);
					if (name === defaultName) opImportDefault = declare;else importedDeclares.push(declare);
				}
				this.imports.push(new _MsAst.Import(this.loc, path, importedDeclares, opImportDefault));
			}
		});

		const amd = amdWrapModule(this.doImports, this.imports, body);

		return new _esastDistAst.Program((0, _util.cat)((0, _util.opIf)(_context.options.includeUseStrict(), () => UseStrict), (0, _util.opIf)(_context.options.includeAmdefine(), () => AmdefineHeader), (0, _esastDistUtil.toStatement)(amd)));
	}

	function amdWrapModule(doImports, imports, body) {
		const shouldImportBoot = _context.options.importBoot();

		const allImports = doImports.concat(imports);
		const allImportPaths = allImports.map(_ => (0, _manglePath2.default)(_.path));

		const arrImportPaths = new _esastDistAst.ArrayExpression((0, _util.cat)((0, _util.opIf)(shouldImportBoot, () => new _esastDistAst.Literal(_context.options.bootPath())), LitStrExports, allImportPaths.map(_ => new _esastDistAst.Literal(_))));

		const importToIdentifier = new Map();
		const importIdentifiers = [];
		for (let i = 0; i < allImports.length; i = i + 1) {
			const _ = allImports[i];
			const id = (0, _esastDistUtil.identifier)(`${ pathBaseName(_.path) }_${ i }`);
			importIdentifiers.push(id);
			importToIdentifier.set(_, id);
		}

		const importArgs = (0, _util.cat)((0, _util.opIf)(shouldImportBoot, () => IdBoot), _astConstants.IdExports, importIdentifiers);

		const doBoot = (0, _util.opIf)(shouldImportBoot, () => new _esastDistAst.ExpressionStatement((0, _msCall.msGetModule)(IdBoot)));

		const importDos = doImports.map(_ => (0, _esastDistUtil.loc)(new _esastDistAst.ExpressionStatement((0, _msCall.msGetModule)(importToIdentifier.get(_))), _.loc));

		// Extracts imported values from the modules.
		const opDeclareImportedLocals = (0, _util.opIf)(!(0, _util.isEmpty)(imports), () => new _esastDistAst.VariableDeclaration('const', (0, _util.flatMap)(imports, _ => importDeclarators(_, importToIdentifier.get(_)))));

		const fullBody = new _esastDistAst.BlockStatement((0, _util.cat)(doBoot, importDos, opDeclareImportedLocals, body, ReturnExports));

		const lazyBody = _context.options.lazyModule() ? new _esastDistAst.BlockStatement([new _esastDistAst.ExpressionStatement(new _esastDistAst.AssignmentExpression('=', ExportsGet, (0, _msCall.msLazy)((0, _esastDistUtil.functionExpressionThunk)(fullBody))))]) : fullBody;

		return new _esastDistAst.CallExpression(IdDefine, [arrImportPaths, new _esastDistAst.ArrowFunctionExpression(importArgs, lazyBody)]);
	}

	function pathBaseName(path) {
		return path.substr(path.lastIndexOf('/') + 1);
	}

	function importDeclarators(_ref, moduleIdentifier) {
		let imported = _ref.imported;
		let opImportDefault = _ref.opImportDefault;

		// TODO: Could be neater about this
		const isLazy = ((0, _util.isEmpty)(imported) ? opImportDefault : imported[0]).isLazy();
		const value = (isLazy ? _msCall.msLazyGetModule : _msCall.msGetModule)(moduleIdentifier);

		const importedDefault = (0, _util.opMap)(opImportDefault, def => {
			const defexp = (0, _msCall.msGetDefaultExport)(moduleIdentifier);
			const val = isLazy ? (0, _msCall.lazyWrap)(defexp) : defexp;
			return (0, _esastDistUtil.loc)(new _esastDistAst.VariableDeclarator((0, _util2.idForDeclareCached)(def), val), def.loc);
		});

		const importedDestruct = (0, _util.isEmpty)(imported) ? null : (0, _transpile.makeDestructureDeclarators)(imported, isLazy, value, true, false);

		return (0, _util.cat)(importedDefault, importedDestruct);
	}

	const IdBoot = new _esastDistAst.Identifier('_boot');
	const IdDefine = new _esastDistAst.Identifier('define');
	const ExportsGet = (0, _esastDistUtil.member)(_astConstants.IdExports, '_get');
	const LitStrExports = new _esastDistAst.Literal('exports');
	const ReturnExports = new _esastDistAst.ReturnStatement(_astConstants.IdExports);
	const UseStrict = new _esastDistAst.ExpressionStatement(new _esastDistAst.Literal('use strict'));

	// if (typeof define !== 'function') var define = require('amdefine')(module)
	const AmdefineHeader = new _esastDistAst.IfStatement(new _esastDistAst.BinaryExpression('!==', new _esastDistAst.UnaryExpression('typeof', IdDefine), new _esastDistAst.Literal('function')), new _esastDistAst.VariableDeclaration('var', [new _esastDistAst.VariableDeclarator(IdDefine, new _esastDistAst.CallExpression(new _esastDistAst.CallExpression(new _esastDistAst.Identifier('require'), [new _esastDistAst.Literal('amdefine')]), [new _esastDistAst.Identifier('module')]))]));
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRyYW5zcGlsZU1vZHVsZS5qcyIsInByaXZhdGUvdHJhbnNwaWxlL3RyYW5zcGlsZU1vZHVsZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7O2tCQ2N3QixlQUFlOzs7Ozs7QUFBeEIsVUFBUyxlQUFlLEdBQUc7QUFDekMsUUFBTSxJQUFJLEdBQUcsV0FIYyxNQUFNLEVBR2IsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFBOztBQUUvQixhQU5tQyxhQUFhLENBTWxDLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxJQUFJLEtBQUs7QUFDNUQsT0FBSSxJQUFJLEtBQUssUUFBUSxFQUFFO0FBQ3RCLFVBQU0sZ0JBQWdCLEdBQUcsRUFBRSxDQUFBO0FBQzNCLFFBQUksZUFBZSxHQUFHLElBQUksQ0FBQTtBQUMxQixRQUFJLFdBQVcsR0FBRyxVQWJVLElBQUksRUFhVCxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7QUFDdkMsU0FBSyxNQUFNLElBQUksSUFBSSxRQUFRLEVBQUU7QUFDNUIsV0FBTSxPQUFPLEdBQUcsT0FoQkosWUFBWSxDQWdCSyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQTtBQUNsRCxTQUFJLElBQUksS0FBSyxXQUFXLEVBQ3ZCLGVBQWUsR0FBRyxPQUFPLENBQUEsS0FFekIsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0tBQy9CO0FBQ0QsUUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsV0F0QmIsTUFBTSxDQXNCa0IsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLEVBQUUsZ0JBQWdCLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQTtJQUNoRjtHQUNELENBQUMsQ0FBQTs7QUFFRixRQUFNLEdBQUcsR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFBOztB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RyxrQkFoSGUsbUJBQW1CLENBZ0hWLGtCQWhIcUMsT0FBTyxDQWdIaEMsWUFBWSxDQUFDLENBQUMsQ0FBQTs7O0FBR3BFLE9BQU0sY0FBYyxHQUFHLGtCQW5IMkMsV0FBVyxDQW9INUUsa0JBckh1RSxnQkFBZ0IsQ0FxSGxFLEtBQUssRUFDekIsa0JBcEh5RCxlQUFlLENBb0hwRCxRQUFRLEVBQUUsUUFBUSxDQUFDLEVBQ3ZDLGtCQXRINkUsT0FBTyxDQXNIeEUsVUFBVSxDQUFDLENBQUMsRUFDekIsa0JBdEhBLG1CQUFtQixDQXNISyxLQUFLLEVBQUUsQ0FDOUIsa0JBdkhvQixrQkFBa0IsQ0F1SGYsUUFBUSxFQUFFLGtCQXhIbEIsY0FBYyxDQXlINUIsa0JBekhjLGNBQWMsQ0F5SFQsa0JBekhnQyxVQUFVLENBeUgzQixTQUFTLENBQUMsRUFBRSxDQUFDLGtCQXpINkIsT0FBTyxDQXlIeEIsVUFBVSxDQUFDLENBQUMsQ0FBQyxFQUN4RSxDQUFDLGtCQTFIa0QsVUFBVSxDQTBIN0MsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUEiLCJmaWxlIjoicHJpdmF0ZS90cmFuc3BpbGUvdHJhbnNwaWxlTW9kdWxlLmpzIiwic291cmNlc0NvbnRlbnQiOltudWxsLCJpbXBvcnQge0FycmF5RXhwcmVzc2lvbiwgQXJyb3dGdW5jdGlvbkV4cHJlc3Npb24sIEFzc2lnbm1lbnRFeHByZXNzaW9uLCBCaW5hcnlFeHByZXNzaW9uLFxuXHRCbG9ja1N0YXRlbWVudCwgQ2FsbEV4cHJlc3Npb24sIEV4cHJlc3Npb25TdGF0ZW1lbnQsIElkZW50aWZpZXIsIElmU3RhdGVtZW50LCBMaXRlcmFsLCBQcm9ncmFtLFxuXHRWYXJpYWJsZURlY2xhcmF0aW9uLCBWYXJpYWJsZURlY2xhcmF0b3IsIFJldHVyblN0YXRlbWVudCwgVW5hcnlFeHByZXNzaW9uXG5cdH0gZnJvbSAnZXNhc3QvZGlzdC9hc3QnXG5pbXBvcnQge2Z1bmN0aW9uRXhwcmVzc2lvblRodW5rLCBpZGVudGlmaWVyLCBsb2MsIG1lbWJlciwgdG9TdGF0ZW1lbnR9IGZyb20gJ2VzYXN0L2Rpc3QvdXRpbCdcbmltcG9ydCB7b3B0aW9uc30gZnJvbSAnLi4vY29udGV4dCdcbmltcG9ydCBtYW5nbGVQYXRoIGZyb20gJy4uL21hbmdsZVBhdGgnXG5pbXBvcnQge0ltcG9ydCwgTG9jYWxEZWNsYXJlfSBmcm9tICcuLi9Nc0FzdCdcbmltcG9ydCB7Y2F0LCBmbGF0TWFwLCBpc0VtcHR5LCBsYXN0LCBvcElmLCBvcE1hcH0gZnJvbSAnLi4vdXRpbCdcbmltcG9ydCB7SWRFeHBvcnRzfSBmcm9tICcuL2FzdC1jb25zdGFudHMnXG5pbXBvcnQge2xhenlXcmFwLCBtc0dldERlZmF1bHRFeHBvcnQsIG1zR2V0TW9kdWxlLCBtc0xhenksIG1zTGF6eUdldE1vZHVsZX0gZnJvbSAnLi9tcy1jYWxsJ1xuaW1wb3J0IHttYWtlRGVzdHJ1Y3R1cmVEZWNsYXJhdG9ycywgdmVyaWZ5UmVzdWx0c30gZnJvbSAnLi90cmFuc3BpbGUnXG5pbXBvcnQge2lkRm9yRGVjbGFyZUNhY2hlZCwgdExpbmVzfSBmcm9tICcuL3V0aWwnXG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHRyYW5zcGlsZU1vZHVsZSgpIHtcblx0Y29uc3QgYm9keSA9IHRMaW5lcyh0aGlzLmxpbmVzKVxuXG5cdHZlcmlmeVJlc3VsdHMuYnVpbHRpblBhdGhUb05hbWVzLmZvckVhY2goKGltcG9ydGVkLCBwYXRoKSA9PiB7XG5cdFx0aWYgKHBhdGggIT09ICdnbG9iYWwnKSB7XG5cdFx0XHRjb25zdCBpbXBvcnRlZERlY2xhcmVzID0gW11cblx0XHRcdGxldCBvcEltcG9ydERlZmF1bHQgPSBudWxsXG5cdFx0XHRsZXQgZGVmYXVsdE5hbWUgPSBsYXN0KHBhdGguc3BsaXQoJy8nKSlcblx0XHRcdGZvciAoY29uc3QgbmFtZSBvZiBpbXBvcnRlZCkge1xuXHRcdFx0XHRjb25zdCBkZWNsYXJlID0gTG9jYWxEZWNsYXJlLnBsYWluKHRoaXMubG9jLCBuYW1lKVxuXHRcdFx0XHRpZiAobmFtZSA9PT0gZGVmYXVsdE5hbWUpXG5cdFx0XHRcdFx0b3BJbXBvcnREZWZhdWx0ID0gZGVjbGFyZVxuXHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0aW1wb3J0ZWREZWNsYXJlcy5wdXNoKGRlY2xhcmUpXG5cdFx0XHR9XG5cdFx0XHR0aGlzLmltcG9ydHMucHVzaChuZXcgSW1wb3J0KHRoaXMubG9jLCBwYXRoLCBpbXBvcnRlZERlY2xhcmVzLCBvcEltcG9ydERlZmF1bHQpKVxuXHRcdH1cblx0fSlcblxuXHRjb25zdCBhbWQgPSBhbWRXcmFwTW9kdWxlKHRoaXMuZG9JbXBvcnRzLCB0aGlzLmltcG9ydHMsIGJvZHkpXG5cblx0cmV0dXJuIG5ldyBQcm9ncmFtKGNhdChcblx0XHRvcElmKG9wdGlvbnMuaW5jbHVkZVVzZVN0cmljdCgpLCAoKSA9PiBVc2VTdHJpY3QpLFxuXHRcdG9wSWYob3B0aW9ucy5pbmNsdWRlQW1kZWZpbmUoKSwgKCkgPT4gQW1kZWZpbmVIZWFkZXIpLFxuXHRcdHRvU3RhdGVtZW50KGFtZCkpKVxufVxuXG5mdW5jdGlvbiBhbWRXcmFwTW9kdWxlKGRvSW1wb3J0cywgaW1wb3J0cywgYm9keSkge1xuXHRjb25zdCBzaG91bGRJbXBvcnRCb290ID0gb3B0aW9ucy5pbXBvcnRCb290KClcblxuXHRjb25zdCBhbGxJbXBvcnRzID0gZG9JbXBvcnRzLmNvbmNhdChpbXBvcnRzKVxuXHRjb25zdCBhbGxJbXBvcnRQYXRocyA9IGFsbEltcG9ydHMubWFwKF8gPT4gbWFuZ2xlUGF0aChfLnBhdGgpKVxuXG5cdGNvbnN0IGFyckltcG9ydFBhdGhzID0gbmV3IEFycmF5RXhwcmVzc2lvbihjYXQoXG5cdFx0b3BJZihzaG91bGRJbXBvcnRCb290LCAoKSA9PiBuZXcgTGl0ZXJhbChvcHRpb25zLmJvb3RQYXRoKCkpKSxcblx0XHRMaXRTdHJFeHBvcnRzLFxuXHRcdGFsbEltcG9ydFBhdGhzLm1hcChfID0+IG5ldyBMaXRlcmFsKF8pKSkpXG5cblx0Y29uc3QgaW1wb3J0VG9JZGVudGlmaWVyID0gbmV3IE1hcCgpXG5cdGNvbnN0IGltcG9ydElkZW50aWZpZXJzID0gW11cblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBhbGxJbXBvcnRzLmxlbmd0aDsgaSA9IGkgKyAxKSB7XG5cdFx0Y29uc3QgXyA9IGFsbEltcG9ydHNbaV1cblx0XHRjb25zdCBpZCA9IGlkZW50aWZpZXIoYCR7cGF0aEJhc2VOYW1lKF8ucGF0aCl9XyR7aX1gKVxuXHRcdGltcG9ydElkZW50aWZpZXJzLnB1c2goaWQpXG5cdFx0aW1wb3J0VG9JZGVudGlmaWVyLnNldChfLCBpZClcblx0fVxuXG5cdGNvbnN0IGltcG9ydEFyZ3MgPSBjYXQob3BJZihzaG91bGRJbXBvcnRCb290LCAoKSA9PiBJZEJvb3QpLCBJZEV4cG9ydHMsIGltcG9ydElkZW50aWZpZXJzKVxuXG5cdGNvbnN0IGRvQm9vdCA9IG9wSWYoc2hvdWxkSW1wb3J0Qm9vdCwgKCkgPT4gbmV3IEV4cHJlc3Npb25TdGF0ZW1lbnQobXNHZXRNb2R1bGUoSWRCb290KSkpXG5cblx0Y29uc3QgaW1wb3J0RG9zID0gZG9JbXBvcnRzLm1hcChfID0+XG5cdFx0bG9jKG5ldyBFeHByZXNzaW9uU3RhdGVtZW50KG1zR2V0TW9kdWxlKGltcG9ydFRvSWRlbnRpZmllci5nZXQoXykpKSwgXy5sb2MpKVxuXG5cdC8vIEV4dHJhY3RzIGltcG9ydGVkIHZhbHVlcyBmcm9tIHRoZSBtb2R1bGVzLlxuXHRjb25zdCBvcERlY2xhcmVJbXBvcnRlZExvY2FscyA9IG9wSWYoIWlzRW1wdHkoaW1wb3J0cyksXG5cdFx0KCkgPT4gbmV3IFZhcmlhYmxlRGVjbGFyYXRpb24oJ2NvbnN0Jyxcblx0XHRcdGZsYXRNYXAoaW1wb3J0cywgXyA9PiBpbXBvcnREZWNsYXJhdG9ycyhfLCBpbXBvcnRUb0lkZW50aWZpZXIuZ2V0KF8pKSkpKVxuXG5cdGNvbnN0IGZ1bGxCb2R5ID0gbmV3IEJsb2NrU3RhdGVtZW50KGNhdChcblx0XHRkb0Jvb3QsIGltcG9ydERvcywgb3BEZWNsYXJlSW1wb3J0ZWRMb2NhbHMsIGJvZHksIFJldHVybkV4cG9ydHMpKVxuXG5cdGNvbnN0IGxhenlCb2R5ID1cblx0XHRvcHRpb25zLmxhenlNb2R1bGUoKSA/XG5cdFx0XHRuZXcgQmxvY2tTdGF0ZW1lbnQoW25ldyBFeHByZXNzaW9uU3RhdGVtZW50KFxuXHRcdFx0XHRuZXcgQXNzaWdubWVudEV4cHJlc3Npb24oJz0nLCBFeHBvcnRzR2V0LFxuXHRcdFx0XHRcdG1zTGF6eShmdW5jdGlvbkV4cHJlc3Npb25UaHVuayhmdWxsQm9keSkpKSldKSA6XG5cdFx0XHRmdWxsQm9keVxuXG5cdHJldHVybiBuZXcgQ2FsbEV4cHJlc3Npb24oSWREZWZpbmUsXG5cdFx0W2FyckltcG9ydFBhdGhzLCBuZXcgQXJyb3dGdW5jdGlvbkV4cHJlc3Npb24oaW1wb3J0QXJncywgbGF6eUJvZHkpXSlcbn1cblxuZnVuY3Rpb24gcGF0aEJhc2VOYW1lKHBhdGgpIHtcblx0cmV0dXJuIHBhdGguc3Vic3RyKHBhdGgubGFzdEluZGV4T2YoJy8nKSArIDEpXG59XG5cbmZ1bmN0aW9uIGltcG9ydERlY2xhcmF0b3JzKHtpbXBvcnRlZCwgb3BJbXBvcnREZWZhdWx0fSwgbW9kdWxlSWRlbnRpZmllcikge1xuXHQvLyBUT0RPOiBDb3VsZCBiZSBuZWF0ZXIgYWJvdXQgdGhpc1xuXHRjb25zdCBpc0xhenkgPSAoaXNFbXB0eShpbXBvcnRlZCkgPyBvcEltcG9ydERlZmF1bHQgOiBpbXBvcnRlZFswXSkuaXNMYXp5KClcblx0Y29uc3QgdmFsdWUgPSAoaXNMYXp5ID8gbXNMYXp5R2V0TW9kdWxlIDogbXNHZXRNb2R1bGUpKG1vZHVsZUlkZW50aWZpZXIpXG5cblx0Y29uc3QgaW1wb3J0ZWREZWZhdWx0ID0gb3BNYXAob3BJbXBvcnREZWZhdWx0LCBkZWYgPT4ge1xuXHRcdGNvbnN0IGRlZmV4cCA9IG1zR2V0RGVmYXVsdEV4cG9ydChtb2R1bGVJZGVudGlmaWVyKVxuXHRcdGNvbnN0IHZhbCA9IGlzTGF6eSA/IGxhenlXcmFwKGRlZmV4cCkgOiBkZWZleHBcblx0XHRyZXR1cm4gbG9jKG5ldyBWYXJpYWJsZURlY2xhcmF0b3IoaWRGb3JEZWNsYXJlQ2FjaGVkKGRlZiksIHZhbCksIGRlZi5sb2MpXG5cdH0pXG5cblx0Y29uc3QgaW1wb3J0ZWREZXN0cnVjdCA9IGlzRW1wdHkoaW1wb3J0ZWQpID8gbnVsbCA6XG5cdFx0bWFrZURlc3RydWN0dXJlRGVjbGFyYXRvcnMoaW1wb3J0ZWQsIGlzTGF6eSwgdmFsdWUsIHRydWUsIGZhbHNlKVxuXG5cdHJldHVybiBjYXQoaW1wb3J0ZWREZWZhdWx0LCBpbXBvcnRlZERlc3RydWN0KVxufVxuXG5jb25zdCBJZEJvb3QgPSBuZXcgSWRlbnRpZmllcignX2Jvb3QnKVxuY29uc3QgSWREZWZpbmUgPSBuZXcgSWRlbnRpZmllcignZGVmaW5lJylcbmNvbnN0IEV4cG9ydHNHZXQgPSBtZW1iZXIoSWRFeHBvcnRzLCAnX2dldCcpXG5jb25zdCBMaXRTdHJFeHBvcnRzID0gbmV3IExpdGVyYWwoJ2V4cG9ydHMnKVxuY29uc3QgUmV0dXJuRXhwb3J0cyA9IG5ldyBSZXR1cm5TdGF0ZW1lbnQoSWRFeHBvcnRzKVxuY29uc3QgVXNlU3RyaWN0ID0gbmV3IEV4cHJlc3Npb25TdGF0ZW1lbnQobmV3IExpdGVyYWwoJ3VzZSBzdHJpY3QnKSlcblxuLy8gaWYgKHR5cGVvZiBkZWZpbmUgIT09ICdmdW5jdGlvbicpIHZhciBkZWZpbmUgPSByZXF1aXJlKCdhbWRlZmluZScpKG1vZHVsZSlcbmNvbnN0IEFtZGVmaW5lSGVhZGVyID0gbmV3IElmU3RhdGVtZW50KFxuXHRuZXcgQmluYXJ5RXhwcmVzc2lvbignIT09Jyxcblx0XHRuZXcgVW5hcnlFeHByZXNzaW9uKCd0eXBlb2YnLCBJZERlZmluZSksXG5cdFx0bmV3IExpdGVyYWwoJ2Z1bmN0aW9uJykpLFxuXHRuZXcgVmFyaWFibGVEZWNsYXJhdGlvbigndmFyJywgW1xuXHRcdG5ldyBWYXJpYWJsZURlY2xhcmF0b3IoSWREZWZpbmUsIG5ldyBDYWxsRXhwcmVzc2lvbihcblx0XHRcdG5ldyBDYWxsRXhwcmVzc2lvbihuZXcgSWRlbnRpZmllcigncmVxdWlyZScpLCBbbmV3IExpdGVyYWwoJ2FtZGVmaW5lJyldKSxcblx0XHRcdFtuZXcgSWRlbnRpZmllcignbW9kdWxlJyldKSldKSlcbiJdLCJzb3VyY2VSb290IjoiL3NyYyJ9
